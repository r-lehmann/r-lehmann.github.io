{"version":3,"file":"requester.js","names":["_tsRes","require","_kameleoonError","_constants","_nonce","_defineProperty","obj","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","Requester","Nonce","constructor","siteCode","environment","packageInfo","requestDispatcher","getClientConfiguration","timeStamp","environmentParam","UrlParameter","Environment","timeStampParam","Ts","requestUrl","URL","CLIENT_CONFIGURATION","UrlQuery","Mobile","response","Ok","error","Err","getRemoteData","DATA","Key","encodeURI","KameleoonError","KameleoonException","RemoteData","trackExperiment","variationId","visitorCode","experimentId","isUnallocated","body","userAgent","callback","url","getTrackingUrl","unallocatedAddition","UrlEventType","Activity","nonce","bodyAddition","Experiment","Id","VariationId","extendedBody","headers","Header","UserAgent","track","trackData","type","version","TRACKING","VisitorCode","encodeURIComponent","SdkName","SdkVersion","exports"],"sources":["../../src/requester/requester.ts"],"sourcesContent":["import { Err, Ok, Result } from 'ts-res';\nimport { Environment, ExternalPackageInfoType } from '../types';\nimport { KameleoonError, KameleoonException } from '../kameleoonError';\nimport { URL, UrlParameter, Header, UrlQuery, UrlEventType } from './constants';\nimport {\n  GetClientConfigurationResultType,\n  RequesterParamsType,\n  TrackDataParamsType,\n  TrackExperimentParamsType,\n  IExternalRequestDispatcher,\n} from './types';\nimport { JSONType } from '../campaignConfiguration';\nimport { Nonce } from '../kameleoonData/nonce';\n\nexport interface IRequester {\n  getClientConfiguration: () => Promise<\n    Result<GetClientConfigurationResultType, KameleoonError>\n  >;\n  getRemoteData: (key: string) => Promise<Result<JSONType, KameleoonError>>;\n  trackExperiment: ({\n    variationId,\n    visitorCode,\n    experimentId,\n    isUnallocated,\n    callback,\n    body,\n  }: TrackExperimentParamsType) => Promise<void>;\n  trackData: ({ visitorCode, body }: TrackDataParamsType) => Promise<void>;\n}\n\nexport class Requester extends Nonce implements IRequester {\n  private siteCode: string;\n  private environment?: Environment;\n  private requestDispatcher: IExternalRequestDispatcher;\n  private packageInfo: ExternalPackageInfoType;\n\n  constructor({\n    siteCode,\n    environment,\n    packageInfo,\n    requestDispatcher,\n  }: RequesterParamsType) {\n    super();\n\n    this.requestDispatcher = requestDispatcher;\n    this.siteCode = siteCode;\n    this.environment = environment;\n    this.packageInfo = packageInfo;\n  }\n\n  public async getClientConfiguration(\n    timeStamp?: number,\n  ): Promise<Result<GetClientConfigurationResultType, KameleoonError>> {\n    const environmentParam = this.environment\n      ? UrlParameter.Environment + this.environment\n      : '';\n    const timeStampParam = timeStamp ? UrlParameter.Ts + timeStamp : '';\n\n    const requestUrl =\n      URL.CLIENT_CONFIGURATION +\n      UrlQuery.Mobile +\n      this.siteCode +\n      environmentParam +\n      timeStampParam;\n\n    try {\n      const response = await this.requestDispatcher.getClientConfiguration(\n        requestUrl,\n      );\n\n      return Ok(response as GetClientConfigurationResultType);\n    } catch (error) {\n      return Err(error as KameleoonError);\n    }\n  }\n\n  public async getRemoteData(\n    key: string,\n  ): Promise<Result<JSONType, KameleoonError>> {\n    const requestUrl: string =\n      URL.DATA + this.siteCode + UrlParameter.Key + encodeURI(key);\n\n    const response = await this.requestDispatcher.getRemoteData(requestUrl);\n\n    if (!response) {\n      return Err(new KameleoonError(KameleoonException.RemoteData));\n    }\n\n    return Ok(response);\n  }\n\n  public async trackExperiment({\n    variationId,\n    visitorCode,\n    experimentId,\n    isUnallocated,\n    body,\n    userAgent,\n    callback,\n  }: TrackExperimentParamsType): Promise<void> {\n    const url = this.getTrackingUrl(visitorCode);\n\n    const unallocatedAddition = !body\n      ? UrlEventType.Activity + UrlParameter.Nonce + this.nonce\n      : '';\n    const bodyAddition = isUnallocated\n      ? unallocatedAddition\n      : UrlEventType.Experiment +\n        UrlParameter.Id +\n        experimentId +\n        UrlParameter.VariationId +\n        variationId +\n        UrlParameter.Nonce +\n        this.nonce;\n    const extendedBody = bodyAddition ? body + '\\n' + bodyAddition : body;\n\n    const headers = userAgent\n      ? {\n          [Header.UserAgent]: userAgent,\n        }\n      : undefined;\n\n    const response = await this.requestDispatcher.track({\n      url,\n      headers,\n      body: extendedBody,\n    });\n\n    if (response && callback) {\n      callback();\n    }\n  }\n\n  public async trackData({\n    visitorCode,\n    body,\n    userAgent,\n  }: TrackDataParamsType): Promise<void> {\n    const url = this.getTrackingUrl(visitorCode);\n\n    const headers = userAgent\n      ? {\n          [Header.UserAgent]: userAgent,\n        }\n      : undefined;\n\n    this.requestDispatcher.track({\n      url,\n      headers,\n      body,\n    });\n  }\n\n  private getTrackingUrl(visitorCode: string): string {\n    const { type, version } = this.packageInfo;\n\n    return (\n      URL.TRACKING +\n      this.siteCode +\n      UrlParameter.VisitorCode +\n      encodeURIComponent(visitorCode) +\n      UrlParameter.SdkName +\n      type +\n      UrlParameter.SdkVersion +\n      version\n    );\n  }\n}\n"],"mappings":"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"}