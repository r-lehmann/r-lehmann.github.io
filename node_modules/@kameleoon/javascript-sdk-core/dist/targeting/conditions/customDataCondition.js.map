{"version":3,"file":"customDataCondition.js","names":["_tsRes","require","_kameleoonData","_kameleoonError","_types","_defineProperty","obj","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","CustomDataCondition","constructor","customDataIndex","valueMatchType","isInclude","inverseResult","matchType","conditionValue","evaluate","targetingData","isCustomData","data","type","KameleoonData","CustomData","filteredData","map","item","filter","index","length","lastDataItem","customDataValue","result","checkCondition","error","Err","Ok","MatchTypeCustomData","UNDEFINED","AMONG_VALUES","parseArray","ok","resultData","Set","Array","isArray","some","has","includes","CONTAINS","EXACT","REGULAR_EXPRESSION","parseRegExp","test","LOWER","EQUAL","GREATER","TRUE","toLowerCase","FALSE","_","expression","flags","split","RegExp","JSON","parse","err","KameleoonError","KameleoonException","AmongValuesCheck","exports"],"sources":["../../../src/targeting/conditions/customDataCondition.ts"],"sourcesContent":["import { Err, Ok, Result } from 'ts-res';\nimport {\n  KameleoonData,\n  CustomDataType,\n  KameleoonDataItemType,\n} from '../../kameleoonData';\nimport { KameleoonError, KameleoonException } from '../../kameleoonError';\nimport { EvaluationDataType, MatchTypeCustomData } from '../types';\nimport { ConditionDataType, ICondition } from './types';\n\nexport class CustomDataCondition implements ICondition {\n  private customDataIndex: number;\n  private matchType: MatchTypeCustomData | null;\n  private inverseResult: boolean;\n  private conditionValue: string | null;\n  private error?: KameleoonError;\n\n  constructor({\n    customDataIndex,\n    valueMatchType,\n    isInclude,\n    value,\n  }: ConditionDataType) {\n    this.customDataIndex = Number(customDataIndex);\n    this.inverseResult = !(isInclude ?? true);\n    this.matchType = valueMatchType;\n    this.conditionValue = value;\n  }\n\n  public evaluate({\n    targetingData,\n  }: EvaluationDataType): Result<boolean, KameleoonError> {\n    const isCustomData = (\n      data: KameleoonDataItemType,\n    ): data is CustomDataType => data.type === KameleoonData.CustomData;\n\n    const filteredData = targetingData\n      .map((item) => item.data)\n      .filter(isCustomData)\n      .filter((item) => item.index === this.customDataIndex);\n\n    if (filteredData.length) {\n      const lastDataItem = filteredData[filteredData.length - 1];\n      const { value: customDataValue } = lastDataItem;\n      const result = this.inverseResult\n        ? !this.checkCondition(customDataValue)\n        : this.checkCondition(customDataValue);\n\n      if (this.error) {\n        return Err(this.error);\n      }\n\n      return Ok(result);\n    }\n\n    return Ok(this.matchType === MatchTypeCustomData.UNDEFINED);\n  }\n\n  private checkCondition(customDataValue: CustomDataType['value']): boolean {\n    if (this.conditionValue === null) {\n      return false;\n    }\n\n    // --- Note ---\n    // `AMONG_VALUES` is checked separately to avoid recursion overhead\n    // for `JSON.parse` inside `this.parseArray`\n    if (this.matchType === MatchTypeCustomData.AMONG_VALUES) {\n      const result = this.parseArray(this.conditionValue);\n\n      if (!result.ok) {\n        this.error = result.error;\n\n        return false;\n      }\n\n      const resultData = new Set(result.data);\n\n      return Array.isArray(customDataValue)\n        ? customDataValue.some((value) => resultData.has(value))\n        : result.data.includes(customDataValue);\n    }\n\n    if (Array.isArray(customDataValue)) {\n      return customDataValue.some((value) => this.checkCondition(value));\n    }\n\n    switch (this.matchType) {\n      case MatchTypeCustomData.CONTAINS:\n        return customDataValue.includes(this.conditionValue);\n      case MatchTypeCustomData.EXACT:\n        return customDataValue === this.conditionValue;\n      case MatchTypeCustomData.REGULAR_EXPRESSION:\n        return this.parseRegExp(this.conditionValue).test(customDataValue);\n      case MatchTypeCustomData.LOWER:\n        return Number(customDataValue) < Number(this.conditionValue);\n      case MatchTypeCustomData.EQUAL:\n        return Number(customDataValue) === Number(this.conditionValue);\n      case MatchTypeCustomData.GREATER:\n        return Number(customDataValue) > Number(this.conditionValue);\n      case MatchTypeCustomData.TRUE:\n        return customDataValue.toLowerCase() === 'true';\n      case MatchTypeCustomData.FALSE:\n        return customDataValue.toLowerCase() === 'false';\n      default:\n        return false;\n    }\n  }\n\n  private parseRegExp(value: string): RegExp {\n    if (value[0] === '/') {\n      const [_, expression, flags] = value.split('/');\n\n      return new RegExp(expression, flags);\n    }\n\n    return new RegExp(value);\n  }\n\n  private parseArray(value: string): Result<string[], KameleoonError> {\n    try {\n      const result = JSON.parse(value);\n\n      if (Array.isArray(result)) {\n        return Ok(result);\n      }\n    } catch (err) {\n      return Err(\n        new KameleoonError(KameleoonException.AmongValuesCheck, err, value),\n      );\n    }\n\n    return Ok([]);\n  }\n}\n"],"mappings":"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"}